<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Hub - Notes</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Marked for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Load PDF.js for document reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Define the hex for sky blue accent */
        :root {
            --sky-blue-accent: #38bdf8; /* sky-400 */
            --bg-main-grey: #1f2937; /* gray-800 */
            --glass-bg: rgba(31, 41, 55, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        
        /* Custom Glowing Button Animation */
        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px var(--sky-blue-accent), 0 0 10px var(--sky-blue-accent), 0 0 20px var(--sky-blue-accent), 0 0 30px rgba(56, 189, 248, 0.4);
            }
            50% {
                box-shadow: 0 0 10px var(--sky-blue-accent), 0 0 20px var(--sky-blue-accent), 0 0 30px var(--sky-blue-accent), 0 0 40px rgba(56, 189, 248, 0.6);
            }
        }

        /* Custom Icon Spinner */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #loading-overlay {
            z-index: 50;
            transition: opacity 0.5s ease-out;
            background-color: var(--bg-main-grey);
        }
        .icon-spinner {
            animation: spin 1.5s linear infinite;
        }

        /* Custom scroll transition for main content */
        .content-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .content-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Tailwind configuration for custom glow color */
        .glow-button {
            animation: glow 2s infinite ease-in-out;
        }

        /* Markdown Styles */
        .prose h3 { color: #38bdf8; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose p { margin-bottom: 0.8em; }
        .prose strong { color: #f3f4f6; font-weight: 700; }
        .prose code { background-color: #374151; padding: 0.2em 0.4em; rounded: 0.25rem; color: #e5e7eb; }

        /* Custom Scrollbar for Chat */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Glassmorphism Card */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        /* Base styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main-grey); 
            color: #f3f4f6; 
            line-height: 1.6;
        }
        
        .tab-active {
            border-bottom: 2px solid #38bdf8;
            color: #38bdf8;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #9ca3af;
        }
        .tab-inactive:hover {
            color: #d1d5db;
        }
    </style>
</head>
<body class="min-h-screen antialiased bg-gray-800">

    <!-- 1. Loading Preview Overlay -->
    <div id="loading-overlay" class="fixed inset-0 flex items-center justify-center">
        <svg class="icon-spinner w-16 h-16 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <line x1="10" y1="9" x2="8" y2="9"></line>
        </svg>
    </div>

    <!-- Main Content Container -->
    <div id="main-content" class="min-h-screen flex flex-col pt-20">

        <!-- 1. Header Section -->
        <header class="fixed top-0 left-0 right-0 z-10 bg-gray-800 bg-opacity-95 shadow-md border-b border-gray-700 backdrop-blur-sm transition-all duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="text-2xl font-extrabold text-white tracking-tight">
                    <span class="text-sky-400">Hub</span>Notes
                </div>
                <nav class="flex space-x-4">
                    <a href="4assign.html" class="p-2 rounded-lg transition duration-300 hover:bg-gray-700 text-gray-300 hover:text-sky-400 flex items-center space-x-1">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                            <line x1="12" y1="11" x2="12" y2="17"></line>
                            <line x1="9" y1="14" x2="15" y2="14"></line>
                        </svg>
                        <span class="hidden sm:inline font-semibold">Assignments</span>
                    </a>
                    <a href="4record.html" class="p-2 rounded-lg transition duration-300 hover:bg-gray-700 text-gray-300 hover:text-sky-400 flex items-center space-x-1">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span class="hidden sm:inline font-semibold">Record Work</span>
                    </a>
                </nav>
            </div>
        </header>

        <!-- 2. Main Body Hero Section -->
        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            <div id="hero-title" class="content-section text-center mb-12">
                <h1 class="text-5xl md:text-6xl font-extrabold text-white mb-4">
                    Master Your <span class="text-sky-400">Curriculum</span>
                </h1>
                <p class="text-xl text-gray-400 max-w-2xl mx-auto">
                    Select a subject below to dive into your learning materials. Clean notes, sharp focus.
                </p>
            </div>

            <!-- Subject Cards Grid -->
            <div class="content-section grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-16" id="subject-cards-container">
                <a href="python.html" class="subject-card group block p-6 bg-gray-700 border border-gray-600 rounded-xl transition duration-500 ease-in-out hover:shadow-xl hover:shadow-sky-900/40 hover:border-sky-500 transform hover:-translate-y-1">
                    <div class="flex flex-col h-full">
                        <svg class="w-10 h-10 mb-4 text-sky-400 group-hover:text-sky-300 transition duration-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="16 18 22 12 16 6"></polyline>
                            <polyline points="8 6 2 12 8 18"></polyline>
                        </svg>
                        <h2 class="text-2xl font-bold text-white mb-2">Python</h2>
                        <p class="text-gray-300 text-sm flex-grow">Deep dive into data structures.</p>
                        <div class="mt-4 text-sky-400 font-semibold group-hover:underline transition duration-300">Start Learning &rarr;</div>
                    </div>
                </a>
                <a href="os.html" class="subject-card group block p-6 bg-gray-700 border border-gray-600 rounded-xl transition duration-500 ease-in-out hover:shadow-xl hover:shadow-sky-900/40 hover:border-sky-500 transform hover:-translate-y-1">
                    <div class="flex flex-col h-full">
                        <svg class="w-10 h-10 mb-4 text-sky-400 group-hover:text-sky-300 transition duration-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        <h2 class="text-2xl font-bold text-white mb-2">OS</h2>
                        <p class="text-gray-300 text-sm flex-grow">Concurrency and memory.</p>
                        <div class="mt-4 text-sky-400 font-semibold group-hover:underline transition duration-300">Start Learning &rarr;</div>
                    </div>
                </a>
                <a href="sub3.html" class="subject-card group block p-6 bg-gray-700 border border-gray-600 rounded-xl transition duration-500 ease-in-out hover:shadow-xl hover:shadow-sky-900/40 hover:border-sky-500 transform hover:-translate-y-1">
                    <div class="flex flex-col h-full">
                        <svg class="w-10 h-10 mb-4 text-sky-400 group-hover:text-sky-300 transition duration-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                            <line x1="4" y1="22" x2="4" y2="15"></line>
                        </svg>
                        <h2 class="text-2xl font-bold text-white mb-2">Subject 3</h2>
                        <p class="text-gray-300 text-sm flex-grow">Database Management.</p>
                        <div class="mt-4 text-sky-400 font-semibold group-hover:underline transition duration-300">Start Learning &rarr;</div>
                    </div>
                </a>
                <a href="sub4.html" class="subject-card group block p-6 bg-gray-700 border border-gray-600 rounded-xl transition duration-500 ease-in-out hover:shadow-xl hover:shadow-sky-900/40 hover:border-sky-500 transform hover:-translate-y-1">
                    <div class="flex flex-col h-full">
                        <svg class="w-10 h-10 mb-4 text-sky-400 group-hover:text-sky-300 transition duration-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <h2 class="text-2xl font-bold text-white mb-2">Subject 4</h2>
                        <p class="text-gray-300 text-sm flex-grow">Artificial Intelligence.</p>
                        <div class="mt-4 text-sky-400 font-semibold group-hover:underline transition duration-300">Start Learning &rarr;</div>
                    </div>
                </a>
            </div>

            <!-- NEW AI Features Section (Redesigned) -->
            <div class="content-section max-w-5xl mx-auto mt-16 glass-panel rounded-2xl shadow-2xl relative overflow-hidden">
                <!-- Header -->
                <div class="p-6 border-b border-gray-700 bg-gray-800/50 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-sky-900/50 flex items-center justify-center border border-sky-500/30">
                            <span class="text-xl">ü§ñ</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white">AI Study Companion</h2>
                            <p class="text-xs text-sky-400">Powered by Gemini ‚Ä¢ History Saved</p>
                        </div>
                    </div>
                    <!-- Tabs -->
                    <div class="flex space-x-6">
                        <button onclick="switchTab('quick')" id="tab-quick" class="tab-active pb-2 font-medium transition-colors">Quick Tools</button>
                        <button onclick="switchTab('chat')" id="tab-chat" class="tab-inactive pb-2 font-medium transition-colors">Tutor Chat</button>
                    </div>
                </div>

                <div class="p-6 min-h-[400px]">
                    
                    <!-- TAB 1: Quick Tools -->
                    <div id="view-quick" class="transition-opacity duration-300">
                        <div class="max-w-3xl mx-auto">
                            <label class="block text-sm font-medium text-gray-300 mb-3">What concept are you working on?</label>
                            <div class="relative mb-8">
                                <input type="text" id="quick-topic" placeholder="e.g. Python Lists, Deadlocks, TCP/IP..." 
                                    class="w-full p-4 bg-gray-900 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-transparent shadow-inner text-lg">
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                                <button onclick="triggerQuickTask('explain')" class="p-4 bg-gray-800 hover:bg-gray-750 border border-gray-700 hover:border-sky-500 rounded-xl text-left group transition-all duration-300 hover:shadow-lg hover:shadow-sky-900/20">
                                    <div class="text-2xl mb-2">üìù</div>
                                    <h3 class="font-bold text-white group-hover:text-sky-400">Explain</h3>
                                    <p class="text-xs text-gray-400 mt-1">Get a clear, concise explanation.</p>
                                </button>
                                <button onclick="triggerQuickTask('quiz')" class="p-4 bg-gray-800 hover:bg-gray-750 border border-gray-700 hover:border-sky-500 rounded-xl text-left group transition-all duration-300 hover:shadow-lg hover:shadow-sky-900/20">
                                    <div class="text-2xl mb-2">‚ùì</div>
                                    <h3 class="font-bold text-white group-hover:text-sky-400">Quiz Me</h3>
                                    <p class="text-xs text-gray-400 mt-1">Test knowledge with 3 questions.</p>
                                </button>
                                <button onclick="triggerQuickTask('plan')" class="p-4 bg-gray-800 hover:bg-gray-750 border border-gray-700 hover:border-sky-500 rounded-xl text-left group transition-all duration-300 hover:shadow-lg hover:shadow-sky-900/20">
                                    <div class="text-2xl mb-2">üìÖ</div>
                                    <h3 class="font-bold text-white group-hover:text-sky-400">Study Plan</h3>
                                    <p class="text-xs text-gray-400 mt-1">Get a 1-week structured roadmap.</p>
                                </button>
                            </div>

                            <!-- Result Area -->
                            <div id="quick-result-area" class="hidden bg-gray-900/50 border border-gray-700 rounded-xl p-6 animate-fade-in-up">
                                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                                    <h3 id="quick-result-title" class="font-bold text-white">Result</h3>
                                    <button onclick="closeQuickResult()" class="text-gray-400 hover:text-white text-sm">Close</button>
                                </div>
                                <div id="quick-loading" class="hidden flex items-center justify-center py-8">
                                    <svg class="animate-spin h-6 w-6 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="ml-2 text-sm text-gray-400">Generating...</span>
                                </div>
                                <div id="quick-response" class="prose prose-invert prose-sm max-w-none text-gray-300"></div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: Tutor Chat -->
                    <div id="view-chat" class="hidden h-[500px] flex flex-col relative">
                        <div class="absolute top-0 right-0 z-10 flex items-center gap-2">
                            <button onclick="clearChatHistory()" class="text-xs text-red-400 hover:text-red-300 underline">Clear History</button>
                        </div>
                        
                        <!-- Document Indicator -->
                        <div id="doc-indicator" class="hidden absolute top-0 left-0 right-0 z-10 bg-sky-900/80 border-b border-sky-500/30 px-4 py-2 flex justify-between items-center backdrop-blur-sm">
                            <div class="flex items-center gap-2 text-xs text-sky-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span id="doc-name" class="font-medium truncate max-w-[200px]">Document Loaded</span>
                                <span class="text-sky-400 text-[10px]">(Context Active)</span>
                            </div>
                            <button onclick="clearDocument()" class="text-sky-300 hover:text-white text-xs font-bold">&times;</button>
                        </div>

                        <!-- Chat History -->
                        <div id="chat-history" class="flex-grow overflow-y-auto custom-scrollbar pr-2 mb-4 space-y-4 pt-8">
                            <div class="flex justify-start">
                                <div class="bg-gray-700 text-gray-200 p-3 rounded-2xl rounded-tl-none max-w-[80%] shadow-sm">
                                    Hi! I'm your AI Tutor. Upload a PDF/Text file to ask questions about it, or just chat!
                                </div>
                            </div>
                        </div>
                        
                        <!-- Input Area -->
                        <div class="mt-auto relative flex items-center gap-2">
                            <!-- Hidden File Input -->
                            <input type="file" id="file-upload" class="hidden" accept=".txt,.pdf,.md" onchange="handleFileUpload(this)">
                            
                            <!-- Paperclip Button -->
                            <button onclick="document.getElementById('file-upload').click()" class="p-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-full transition border border-gray-600 hover:border-sky-500" title="Upload Document (PDF/TXT)">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                            </button>

                            <div class="relative flex-grow">
                                <input type="text" id="chat-input" placeholder="Type a message..." 
                                    class="w-full pl-4 pr-12 py-3 bg-gray-900 border border-gray-600 rounded-full text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-sky-500 shadow-lg"
                                    onkeydown="if(event.key === 'Enter') handleChatSend()">
                                <button onclick="handleChatSend()" class="absolute right-2 top-2 p-1.5 bg-sky-600 hover:bg-sky-500 text-white rounded-full transition shadow-md">
                                    <svg class="w-5 h-5 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5m0 0l-7 7m7-7l7 7"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 3. Footer Section -->
        <footer class="mt-auto py-8 border-t border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <p class="text-gray-400 mb-4 text-sm">Unlock exclusive content and advanced features.</p>
                <a href="exclusive.html" class="inline-block py-3 px-8 bg-sky-600 text-white font-extrabold rounded-full transition duration-300 ease-in-out hover:bg-sky-500 glow-button">
                    Access Premium Portal &rarr;
                </a>
                <p class="text-gray-500 mt-6 text-xs">&copy; 2024 Learning Hub. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Modal -->
    <div id="message-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-60 backdrop-blur-sm">
        <div class="bg-gray-800 border border-gray-600 rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-2">Notice</h3>
            <p id="modal-text" class="text-gray-300 mb-6"></p>
            <button onclick="closeModal()" class="w-full py-2 bg-sky-600 hover:bg-sky-500 text-white rounded-lg font-semibold transition">OK</button>
        </div>
    </div>

    <script>
        // --- Init & Animation ---
        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    initializeScrollAnimations();
                }, 500); 
            }, 1000);
            
            // Load Chat History
            loadChatHistory();
        });

        function checkVisibility() {
            const sections = document.querySelectorAll('.content-section');
            const viewportHeight = window.innerHeight;
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top < viewportHeight - (viewportHeight * 0.1) && rect.bottom > 0) {
                    section.classList.add('is-visible');
                }
            });
        }
        function initializeScrollAnimations() {
            checkVisibility();
            window.addEventListener('scroll', checkVisibility);
        }

        // --- AI Logic ---
        const apiKey = ""; 
        let chatHistoryContext = []; 
        let currentDocContext = ""; // Stores text from uploaded file

        // UI State Helpers
        function switchTab(tab) {
            const quickView = document.getElementById('view-quick');
            const chatView = document.getElementById('view-chat');
            const btnQuick = document.getElementById('tab-quick');
            const btnChat = document.getElementById('tab-chat');

            if (tab === 'quick') {
                quickView.classList.remove('hidden');
                chatView.classList.add('hidden');
                btnQuick.className = 'tab-active pb-2 font-medium transition-colors';
                btnChat.className = 'tab-inactive pb-2 font-medium transition-colors';
            } else {
                quickView.classList.add('hidden');
                chatView.classList.remove('hidden');
                btnQuick.className = 'tab-inactive pb-2 font-medium transition-colors';
                btnChat.className = 'tab-active pb-2 font-medium transition-colors';
                const hist = document.getElementById('chat-history');
                hist.scrollTop = hist.scrollHeight;
            }
        }

        const modal = document.getElementById('message-modal');
        const modalText = document.getElementById('modal-text');
        function showModal(msg) { modalText.textContent = msg; modal.classList.remove('hidden'); }
        function closeModal() { modal.classList.add('hidden'); }

        // --- Document Upload Logic ---
        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            showModal(`Reading ${file.name}... this may take a moment.`);
            
            try {
                let text = "";
                if (file.type === "application/pdf") {
                    text = await extractTextFromPDF(file);
                } else {
                    text = await file.text();
                }

                // Truncate if too long (simple heuristic for client-side safety)
                if (text.length > 50000) {
                    text = text.substring(0, 50000) + "\n...[Document Truncated]";
                }

                currentDocContext = text;
                
                // Update UI
                document.getElementById('doc-indicator').classList.remove('hidden');
                document.getElementById('doc-name').textContent = file.name;
                closeModal();
                
                // Notify in chat
                appendMessageToUI('ai', `I've read **${file.name}**. You can now ask me questions about it!`, false);

            } catch (e) {
                console.error(e);
                closeModal();
                showModal("Error reading file. Please try a simple text or PDF file.");
            }
            
            // Reset input so same file can be selected again if needed
            input.value = '';
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `Page ${i}: ${pageText}\n`;
            }
            return fullText;
        }

        function clearDocument() {
            currentDocContext = "";
            document.getElementById('doc-indicator').classList.add('hidden');
        }

        // --- Quick Tools Logic ---
        async function triggerQuickTask(type) {
            const input = document.getElementById('quick-topic');
            const topic = input.value.trim();
            
            if (!topic) { showModal("Please enter a topic first!"); return; }

            const resultArea = document.getElementById('quick-result-area');
            const responseDiv = document.getElementById('quick-response');
            const loadingDiv = document.getElementById('quick-loading');
            const titleDiv = document.getElementById('quick-result-title');

            resultArea.classList.remove('hidden');
            loadingDiv.classList.remove('hidden');
            loadingDiv.classList.add('flex');
            responseDiv.classList.add('hidden');

            let prompt = "";
            if (type === 'explain') {
                titleDiv.textContent = `Explanation: ${topic}`;
                prompt = `Explain "${topic}" simply and clearly. Use bold for key terms.`;
            } else if (type === 'quiz') {
                titleDiv.textContent = `Quiz: ${topic}`;
                prompt = `Create 3 multiple-choice questions about "${topic}". Show answers at the end. Format as Markdown.`;
            } else if (type === 'plan') {
                titleDiv.textContent = `Study Plan: ${topic}`;
                prompt = `Create a 1-week study schedule for "${topic}". Use bullet points.`;
            }

            try {
                const text = await callGemini(prompt);
                responseDiv.innerHTML = marked.parse(text);
                loadingDiv.classList.add('hidden');
                loadingDiv.classList.remove('flex');
                responseDiv.classList.remove('hidden');
            } catch (e) {
                loadingDiv.classList.add('hidden');
                loadingDiv.classList.remove('flex');
                responseDiv.innerHTML = "<span class='text-red-400'>Error connecting to AI.</span>";
                responseDiv.classList.remove('hidden');
            }
        }

        function closeQuickResult() {
            document.getElementById('quick-result-area').classList.add('hidden');
        }

        // --- Chat Logic & Persistence ---
        function loadChatHistory() {
            const saved = localStorage.getItem('hubnotes_chat_v1');
            if (saved) {
                chatHistoryContext = JSON.parse(saved);
                const histDiv = document.getElementById('chat-history');
                if(chatHistoryContext.length > 0) histDiv.innerHTML = '';
                
                chatHistoryContext.forEach(msg => {
                    appendMessageToUI(msg.role, msg.text, false);
                });
            }
        }

        function saveChat() {
            localStorage.setItem('hubnotes_chat_v1', JSON.stringify(chatHistoryContext));
        }

        function clearChatHistory() {
            localStorage.removeItem('hubnotes_chat_v1');
            chatHistoryContext = [];
            document.getElementById('chat-history').innerHTML = `
                <div class="flex justify-start">
                    <div class="bg-gray-700 text-gray-200 p-3 rounded-2xl rounded-tl-none max-w-[80%] shadow-sm">
                        History cleared. Start a new conversation!
                    </div>
                </div>`;
        }

        async function handleChatSend() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            appendMessageToUI('user', msg, true);
            input.value = '';
            
            const histDiv = document.getElementById('chat-history');
            const loadId = 'temp-load-' + Date.now();
            const loadBubble = document.createElement('div');
            loadBubble.className = 'flex justify-start';
            loadBubble.id = loadId;
            loadBubble.innerHTML = `<div class="bg-gray-700 text-gray-400 p-3 rounded-2xl rounded-tl-none"><span class="animate-pulse">...</span></div>`;
            histDiv.appendChild(loadBubble);
            histDiv.scrollTop = histDiv.scrollHeight;

            try {
                // Build payload with Context if available
                let finalPayload = [];
                
                // If document exists, inject it as a system-like message at the start of this turn
                if (currentDocContext) {
                     finalPayload.push({
                        role: 'user',
                        parts: [{ text: `CONTEXT FROM UPLOADED DOCUMENT:\n${currentDocContext}\n\nINSTRUCTION: Answer the following question using the context above if relevant.` }]
                     });
                }

                // Append history
                const historyPayload = chatHistoryContext.map(m => ({
                    role: m.role === 'user' ? 'user' : 'model',
                    parts: [{ text: m.text }]
                }));
                
                finalPayload = [...finalPayload, ...historyPayload];

                // Note: The actual user message was already added to chatHistoryContext by appendMessageToUI(..., true)
                // But wait, for the API call, we need to send the whole history INCLUDING the new message.
                // 'chatHistoryContext' HAS the new message because appendMessageToUI pushes to it before we get here? 
                // No, let's check appendMessageToUI. Yes, it pushes to chatHistoryContext.
                
                // So historyPayload already contains the new user question.
                // We just prepend the doc context to the list if it exists.
                // Actually, a better way for Gemini: Add the context to the *last* user message or first system message.
                // Let's just prepend a context message to the array we send to API (but not save it to visual history).
                
                // RE-CONSTRUCT PAYLOAD:
                // 1. Map existing history
                let apiMessages = chatHistoryContext.map(m => ({
                    role: m.role === 'user' ? 'user' : 'model',
                    parts: [{ text: m.text }]
                }));
                
                // 2. If document context exists, PREPEND it as a separate user message or modify the last one?
                // Modifying the last one is safer to keep conversation flow 'user -> model'.
                if (currentDocContext) {
                    // Find the last user message (which is the current question)
                    const lastMsgIndex = apiMessages.length - 1;
                    if (lastMsgIndex >= 0 && apiMessages[lastMsgIndex].role === 'user') {
                        const originalText = apiMessages[lastMsgIndex].parts[0].text;
                        apiMessages[lastMsgIndex].parts[0].text = `CONTEXT DOCUMENT:\n${currentDocContext}\n\nUSER QUESTION:\n${originalText}`;
                    }
                }

                const responseText = await callGeminiChat(apiMessages);
                
                document.getElementById(loadId).remove();
                appendMessageToUI('ai', responseText, true);

            } catch (e) {
                console.error(e);
                document.getElementById(loadId).remove();
                appendMessageToUI('ai', "Sorry, I couldn't reach the server.", false);
            }
        }

        function appendMessageToUI(role, text, save) {
            const histDiv = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = role === 'user' 
                ? 'bg-sky-600 text-white p-3 rounded-2xl rounded-tr-none max-w-[80%] shadow-md' 
                : 'bg-gray-700 text-gray-200 p-3 rounded-2xl rounded-tl-none max-w-[80%] shadow-sm prose prose-invert prose-sm';
            
            bubble.innerHTML = role === 'user' ? text : marked.parse(text);
            div.appendChild(bubble);
            histDiv.appendChild(div);
            histDiv.scrollTop = histDiv.scrollHeight;

            if (save) {
                chatHistoryContext.push({ role: role, text: text });
                saveChat();
            }
        }

        // --- API Functions ---
        async function callGemini(query) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            return fetchWithBackoff(url, { contents: [{ parts: [{ text: query }] }] });
        }

        async function callGeminiChat(payload) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            return fetchWithBackoff(url, { contents: payload });
        }

        async function fetchWithBackoff(url, body, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    if (!res.ok) throw new Error(res.status);
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
                }
            }
        }
    </script>
</body>
</html>
