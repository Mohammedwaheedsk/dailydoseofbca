<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Dose of BCA</title>

  <!-- Favicons (keep as you had them) -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" href="mylogo-32x32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="mylogo-64x64.png" sizes="64x64" type="image/png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png" sizes="180x180">
  <meta name="theme-color" content="#0f172a">

  <!-- Tailwind CDN (you used it already) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & small libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>

  <style>
    :root {
      --bg: #0f172a;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --glass: rgba(15,23,42,0.6);
    }

    /* Base */
    html,body { height:100%; }
    body{
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0;
      background: var(--bg);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-y: auto;
    }

    /* Mobile-first layout tweaks */
    .container { padding-left:1rem; padding-right:1rem; max-width:1100px; margin:0 auto; }

    /* Header (compact mobile) */
    header.site-header {
      position: fixed;
      top:0; left:0; right:0;
      z-index:60;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: linear-gradient(180deg, rgba(15,23,42,0.7), rgba(15,23,42,0.45));
      border-bottom:1px solid rgba(255,255,255,0.04);
    }
    .header-inner { display:flex; align-items:center; justify-content:space-between; height:64px; max-width:1100px; margin:0 auto; padding:0 1rem; gap:0.5rem; }
    .brand { display:flex; align-items:center; gap:0.75rem; font-weight:800; letter-spacing:-0.5px; }
    .brand .logo { width:36px; height:36px; border-radius:8px; display:inline-grid; place-items:center; background:linear-gradient(135deg,#38bdf8,#2563eb); color:white; font-weight:700; box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
    .brand .title { font-size:1rem; color:white; display:block; line-height:1; }

    /* Hamburger & nav */
    .nav-toggle { display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; border-radius:10px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); }
    .nav-drawer { position: fixed; left:0; right:0; top:64px; background:linear-gradient(180deg, rgba(7,11,20,0.95), rgba(7,11,20,0.9)); border-bottom:1px solid rgba(255,255,255,0.03); padding:0.75rem; display:none; z-index:55; }
    .nav-drawer a { display:block; padding:0.75rem 1rem; border-radius:10px; color:var(--muted); text-decoration:none; margin-bottom:0.5rem; font-weight:600; }
    .nav-drawer a.active, .nav-drawer a:hover { color:var(--accent); background:rgba(56,189,248,0.04); border:1px solid rgba(56,189,248,0.06); }

    /* Background blobs ‚Äî reduced on small screens */
    .blob-cont { position:fixed; inset:0; z-index:-1; pointer-events:none; overflow:hidden; }
    .blob { position:absolute; border-radius:50%; filter:blur(72px); opacity:0.35; transform-origin:center; }
    .blob-1{ width:420px; height:420px; top:-8%; left:-8%; background:#0ea5e9; }
    .blob-2{ width:520px; height:520px; bottom:-10%; right:-6%; background:#6366f1; }
    .blob-3{ width:360px; height:360px; top:38%; left:38%; background:#0f172a; opacity:0.7; }

    @media (max-width:640px){
      .blob-1{ width:280px; height:280px; top:-14%; left:-12%; filter:blur(56px); opacity:0.25; }
      .blob-2{ width:320px; height:320px; bottom:-18%; right:-18%; filter:blur(56px); opacity:0.22; }
      .blob-3{ display:none; }
    }

    /* Hero */
    .hero { padding-top:92px; padding-bottom:20px; text-align:center; }
    .hero h1 {
      font-weight:800;
      line-height:1.02;
      font-size:clamp(1.5rem, 6vw, 2.8rem);
      margin:0 0 0.5rem 0;
      background: linear-gradient(90deg,#fff,#bfe9ff,#38bdf8);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      -webkit-text-fill-color:transparent;
    }
    .hero p { color: #cbd5e1; margin:0 auto; max-width:46ch; font-size:0.95rem; }

    /* Subject cards grid */
    .cards { display:grid; gap:0.75rem; grid-template-columns:1fr; margin-top:1rem; }
    .card {
      display:block;
      padding:1rem;
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);
      transition:transform .22s ease, box-shadow .22s ease;
      text-decoration:none;
      color:inherit;
    }
    .card:hover{ transform:translateY(-6px); box-shadow:0 10px 30px rgba(2,6,23,0.6); }

    .card .icon { width:44px; height:44px; border-radius:10px; display:inline-grid; place-items:center; background: rgba(56,189,248,0.08); margin-bottom:0.5rem; }
    .card h3{ margin:0; font-weight:700; font-size:1rem; }
    .card p{ margin:0.5rem 0 0 0; font-size:0.9rem; color:#9fb0c8; }

    @media(min-width:768px){
      .cards { grid-template-columns: repeat(2,1fr); }
    }
    @media(min-width:1024px){
      .cards { grid-template-columns: repeat(4,1fr); gap:1rem; }
      .header-inner{ height:80px; }
      .hero{ padding-top:120px; }
    }

    /* AI Study Companion card */
    .companion { margin-top:1.25rem; border-radius:18px; overflow:hidden; background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.7)); border:1px solid rgba(56,189,248,0.06); }
    .companion .top { display:flex; gap:0.75rem; align-items:center; justify-content:space-between; padding:1rem; border-bottom:1px solid rgba(255,255,255,0.03); }
    .companion .tabs { display:flex; gap:0.5rem; background:rgba(255,255,255,0.02); padding:0.25rem; border-radius:999px; }
    .companion .tabs button { padding:8px 12px; border-radius:10px; background:transparent; border:none; color:#bcdff6; font-weight:700; }
    .companion .tabs button.active { background:linear-gradient(90deg, rgba(56,189,248,0.12), rgba(37,99,235,0.08)); color:white; box-shadow:0 6px 18px rgba(2,6,23,0.5); }

    /* Quick tools layout */
    .quick-tools { padding:1rem; }
    .quick-input { width:100%; padding:0.9rem 1rem; border-radius:999px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.25); color:white; font-size:1rem; }
    .quick-actions { display:grid; gap:0.6rem; grid-template-columns:1fr; margin-top:0.8rem; }
    .quick-btn {
      display:flex; gap:0.8rem; align-items:center; padding:0.9rem; border-radius:14px; background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.04); text-align:left; cursor:pointer; font-weight:700;
    }
    .quick-btn .emoji { width:44px; height:44px; border-radius:10px; display:grid; place-items:center; background:rgba(56,189,248,0.08); }
    @media(min-width:640px){ .quick-actions { grid-template-columns: repeat(3,1fr); } }

    /* Chat area */
    .chat { padding:1rem; min-height:320px; display:flex; flex-direction:column; gap:0.75rem; }
    .chat-history { flex:1; overflow:auto; padding:0.5rem 0; display:flex; flex-direction:column; gap:0.5rem; max-height:50vh; }
    .bubble { max-width:86%; padding:0.75rem 1rem; border-radius:14px; font-size:0.95rem; }
    .bubble.ai { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); color:#e6eef8; align-self:flex-start; }
    .bubble.user { background:linear-gradient(90deg,#38bdf8,#2563eb); color:white; align-self:flex-end; box-shadow:0 12px 30px rgba(2,6,23,0.5); }
    .chat-controls { display:flex; gap:0.5rem; align-items:center; }
    .file-btn{ padding:10px; border-radius:10px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); display:inline-grid; place-items:center; }
    .text-input { flex:1; padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.24); color:white; font-size:1rem; }

    /* Footer */
    footer { padding:1.2rem 0 2.4rem; text-align:center; color:#9fb0c8; font-size:0.9rem; }

    /* Small accessibility + motion preferences */
    @media (prefers-reduced-motion:reduce){
      * { animation:none !important; transition:none !important; }
    }
  </style>
</head>
<body>

  <div class="blob-cont" aria-hidden="true">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <!-- Header -->
  <header class="site-header" role="banner" aria-label="Main header">
    <div class="header-inner container">
      <div class="brand" aria-hidden="false">
        
<img src="mylogo.jpg"
     srcset="mylogo-1x.jpg 1x, mylogo-2x.jpg 2x"
     alt="Daily Dose of BCA logo"
     class="w-9 h-9 rounded-lg object-cover shadow-md"
     decoding="async" />

        <div>
          <div class="title">Daily Dose of <span style="color:var(--accent)">BCA</span></div>
          <div style="font-size:11px;color:#93b5d8;margin-top:2px;">Notes ‚Ä¢ Prep ‚Ä¢ Companion</div>
        </div>
      </div>

      <!-- Right-side: compact navigation -->
      <div style="display:flex; align-items:center; gap:0.5rem;">
        <button id="open-drawer" class="nav-toggle" aria-expanded="false" aria-controls="main-drawer" title="Open menu">
          <!-- hamburger -->
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 7h16M4 12h16M4 17h16" stroke="#dbeafe" stroke-linecap="round" stroke-linejoin="round"></path></svg>
        </button>
      </div>
    </div>

    <nav id="main-drawer" class="nav-drawer" aria-hidden="true">
      <a href="4assign.html">Assignments</a>
      <a href="4record.html">Record Work</a>
      <a href="exclusive.html" class="active">Premium Content</a>
      <a href="#footer">About</a>
    </nav>
  </header>

  <main class="container" role="main">
    <!-- Hero -->
    <section class="hero">
      <h1>Master your subjects ‚Äî efficiently.</h1>
      <p>Get focused notes, quick quizzes and one-week study plans ‚Äî optimised for mobile learning and quick revision.</p>
    </section>

    <!-- Subjects -->
    <section class="cards" aria-label="Subject cards" id="subject-cards-container">
      <!-- Example card; copy for each subject -->
      <a class="card" href="python.html" aria-label="Open Python notes">
        <div class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" style="color:var(--accent)"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg></div>
        <h3>Python</h3>
        <p>Data structures, algorithms, and practical projects ‚Äî concise notes and examples.</p>
      </a>

      <a class="card" href="os.html" aria-label="Open Operating System notes">
        <div class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" style="color:var(--accent)"><rect x="2" y="3" width="20" height="14" rx="2"></rect></svg></div>
        <h3>Operating System</h3>
        <p>Concurrency, memory management and file systems ‚Äî simplified for revision.</p>
      </a>

      <a class="card" href="mad.html" aria-label="Open MAD notes">
        <div class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" style="color:var(--accent)"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path></svg></div>
        <h3>MAD</h3>
        <p>Mobile app dev concepts and code examples for quick practice.</p>
      </a>

      <a class="card" href="afm.html" aria-label="Open AFM notes">
        <div class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" style="color:var(--accent)"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
        <h3>AFM</h3>
        <p>Accounting fundamentals and shortcuts for exams.</p>
      </a>

      <!-- add other cards similarly -->
    </section>

    <!-- Companion / AI -->
    <section class="companion" aria-labelledby="companion-heading">
      <div class="top">
        <div style="display:flex; gap:0.75rem; align-items:center;">
          <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(90deg,#38bdf8,#2563eb);display:grid;place-items:center;font-weight:700;">‚ú®</div>
          <div>
            <div id="companion-heading" style="font-weight:800;font-size:1.05rem;">AI Study Companion</div>
            <div style="font-size:12px;color:#9fb0c8;">Powered by Waheed</div>
          </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Companion tabs">
          <button id="tab-quick" class="active" role="tab" aria-selected="true">Quick Tools</button>
          <button id="tab-chat" role="tab" aria-selected="false">Chat</button>
        </div>
      </div>

      <div id="companion-body">
        <!-- Quick view (default) -->
        <div id="view-quick" class="quick-tools" aria-hidden="false">
          <label for="quick-topic" class="sr-only">Topic</label>
          <input id="quick-topic" class="quick-input" placeholder="Topic ‚Äî e.g. Python, Sorting algorithm, How to make a website..." />

          <div class="quick-actions" role="toolbar" aria-label="Quick actions">
            <button class="quick-btn" onclick="triggerQuickTask('explain')" type="button" aria-label="Explain">
              <div class="emoji">üìù</div>
              <div>
                <div style="font-weight:800;">Explain</div>
                <div style="font-size:12px;color:#9fb0c8;">Clear, concise notes</div>
              </div>
            </button>

            <button class="quick-btn" onclick="triggerQuickTask('quiz')" type="button" aria-label="Quiz me">
              <div class="emoji">‚ùì</div>
              <div>
                <div style="font-weight:800;">Quiz Me</div>
                <div style="font-size:12px;color:#9fb0c8;">3 quick MCQs</div>
              </div>
            </button>

            <button class="quick-btn" onclick="triggerQuickTask('plan')" type="button" aria-label="Study plan">
              <div class="emoji">üìÖ</div>
              <div>
                <div style="font-weight:800;">Study Plan</div>
                <div style="font-size:12px;color:#9fb0c8;">1-week roadmap</div>
              </div>
            </button>
          </div>

          <div id="quick-result-area" class="mt-4" style="display:none;">
            <div style="background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); padding:0.9rem; border-radius:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                <div id="quick-result-title" style="font-weight:800;">Result</div>
                <button onclick="closeQuickResult()" aria-label="Close results" style="background:none;border:none;color:#9fb0c8;font-weight:700;">‚úï</button>
              </div>
              <div id="quick-loading" style="display:none;padding:1rem;text-align:center;color:var(--muted);">Loading‚Ä¶</div>
              <div id="quick-response" style="color:#dbeafe;"></div>
            </div>
          </div>
        </div>

        <!-- Chat view (hidden by default) -->
        <div id="view-chat" style="display:none; padding:0.75rem;">
          <div class="chat" role="region" aria-label="Chat with AI">
            <div id="chat-history" class="chat-history" aria-live="polite">
              <div class="bubble ai">Hi ‚Äî I'm your AI tutor. Upload a PDF or ask a question to get started.</div>
            </div>

            <div style="display:flex; gap:0.5rem; align-items:center;">
              <input id="file-upload" type="file" accept=".pdf,.txt,.md" style="display:none" onchange="handleFileUpload(this)" />
              <button class="file-btn" onclick="document.getElementById('file-upload').click()" aria-label="Upload document">
                <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M12 3v12" stroke="#cfeefd" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="#cfeefd" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>

              <input id="chat-input" class="text-input" placeholder="Type your message and press Send" onkeydown="if(event.key==='Enter') handleChatSend()" aria-label="Chat message" />
              <button onclick="handleChatSend()" aria-label="Send message" style="padding:10px 12px;border-radius:12px;background:linear-gradient(90deg,#38bdf8,#2563eb);color:white;border:none;font-weight:700;">Send</button>
            </div>
          </div>
        </div>
      </div>

    </section>

    <footer id="footer">
      <div style="margin-top:1rem;">
        <p style="color:#9fb0c8;">Get personalised class chatbot, class materials crafted especially for you.</p>
        <a href="exclusive.html" style="display:inline-block;margin-top:0.6rem;padding:10px 18px;border-radius:999px;background:linear-gradient(90deg,#38bdf8,#2563eb);color:white;font-weight:700;text-decoration:none;">Premium Content</a>
        <p style="margin-top:0.9rem;font-size:12px;color:#7b8798;">&copy; 2024 Learning Hub. All rights reserved.</p>
      </div>
    </footer>
  </main>

  <!-- Lightweight modal for status -->
  <div id="message-modal" role="dialog" aria-modal="true" style="display:none;position:fixed;inset:0;z-index:70;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);backdrop-filter:blur(4px);">
    <div style="max-width:420px;background:var(--glass);padding:1rem;border-radius:14px;border:1px solid rgba(255,255,255,0.04);color:#e6eef8;">
      <div id="modal-text" style="margin-bottom:0.6rem;"></div>
      <div style="text-align:right;"><button onclick="closeModal()" style="background:linear-gradient(90deg,#38bdf8,#2563eb);padding:8px 12px;border-radius:10px;border:none;color:white;font-weight:700;">OK</button></div>
    </div>
  </div>

  <script>
    // ============ Config ============
    // remove any hard-coded api key in public files ‚Äî use runtime injection instead
    let API_KEY = "AIzaSyAUdAKZk8LrXjcalIFnNYoK28uzJJ9OvEM"; // <-- set at runtime, never commit a real key to source control

    // ============ Header Drawer ============
    const openBtn = document.getElementById('open-drawer');
    const drawer = document.getElementById('main-drawer');
    openBtn.addEventListener('click', () => {
      const expanded = openBtn.getAttribute('aria-expanded') === 'true';
      openBtn.setAttribute('aria-expanded', String(!expanded));
      if(!expanded) { drawer.style.display = 'block'; drawer.setAttribute('aria-hidden','false'); }
      else { drawer.style.display = 'none'; drawer.setAttribute('aria-hidden','true'); }
    });

    // Close drawer when clicking outside (mobile)
    document.addEventListener('click', (e) => {
      if(!drawer.contains(e.target) && !openBtn.contains(e.target)) {
        drawer.style.display = 'none';
        drawer.setAttribute('aria-hidden','true');
        openBtn.setAttribute('aria-expanded','false');
      }
    });

    // ============ Tabs (quick/chat) ============
    const tabQuick = document.getElementById('tab-quick');
    const tabChat = document.getElementById('tab-chat');
    const viewQuick = document.getElementById('view-quick');
    const viewChat = document.getElementById('view-chat');
    tabQuick.addEventListener('click', () => {
      tabQuick.classList.add('active'); tabQuick.setAttribute('aria-selected','true');
      tabChat.classList.remove('active'); tabChat.setAttribute('aria-selected','false');
      viewQuick.style.display = ''; viewChat.style.display = 'none';
    });
    tabChat.addEventListener('click', () => {
      tabChat.classList.add('active'); tabChat.setAttribute('aria-selected','true');
      tabQuick.classList.remove('active'); tabQuick.setAttribute('aria-selected','false');
      viewChat.style.display = ''; viewQuick.style.display = 'none';
      scrollChatToBottom();
    });

    // ============ Modal ============
    const modal = document.getElementById('message-modal');
    const modalText = document.getElementById('modal-text');
    function showModal(txt){
      modalText.textContent = txt;
      modal.style.display = 'flex';
    }
    function closeModal(){
      modal.style.display = 'none';
    }

    // ============ File upload (PDF read) ============
    async function handleFileUpload(input) {
      const file = input.files?.[0];
      if(!file) return;
      showModal(`Processing ${file.name}...`);
      try {
        let text = "";
        if(file.type === "application/pdf"){
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          for(let p=1; p<=pdf.numPages; p++){
            const page = await pdf.getPage(p);
            const content = await page.getTextContent();
            text += content.items.map(it => it.str).join(' ') + "\n";
            // stop early if huge
            if(text.length > 120000){ text = text.slice(0,120000) + "\n...[truncated]"; break; }
          }
        } else {
          text = await file.text();
        }
        closeModal();
        appendMessage('ai', `I've processed "${file.name}". Ask me questions about it.`); // friendly confirmation
        // store parsed context briefly
        window.currentDoc = text.slice(0, 120000);
      } catch(err){
        console.error(err); closeModal(); showModal("Failed to read file.");
      } finally {
        input.value = "";
      }
    }

    // ============ Chat / local history ============
    let chatHistory = JSON.parse(localStorage.getItem('dd_bca_chat_v1')||'[]');
    const chatContainer = document.getElementById('chat-history');

    function appendMessage(role, html){
      const div = document.createElement('div');
      div.className = 'bubble ' + (role === 'user' ? 'user' : 'ai');
      // for AI messages we support markdown (quick tools use marked)
      div.innerHTML = (role === 'ai') ? marked.parse(html) : html;
      chatContainer.appendChild(div);
      scrollChatToBottom();
      if(role === 'user' || role === 'ai') {
        chatHistory.push({role, text: html, t: Date.now()});
        localStorage.setItem('dd_bca_chat_v1', JSON.stringify(chatHistory.slice(-200)));
      }
    }

    function scrollChatToBottom(){
      setTimeout(()=>{ chatContainer.scrollTop = chatContainer.scrollHeight; }, 60);
    }

    function handleChatSend(){
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if(!text) return;
      appendMessage('user', text);
      input.value = '';
      // show loading bubble
      const loading = document.createElement('div');
      loading.className = 'bubble ai';
      loading.innerHTML = '<em style="color:var(--muted)">Thinking‚Ä¶</em>';
      chatContainer.appendChild(loading);
      scrollChatToBottom();

      // Prepare payload with optional doc context
      const payloadText = (window.currentDoc ? `CONTEXT:\n${window.currentDoc}\n\nQUESTION:\n${text}` : text);

      // callGemini (example, replace with your server-side proxy)
      callGemini([{ role:'user', parts:[{text: payloadText}] }])
        .then(resp => {
          loading.remove();
          appendMessage('ai', resp);
        })
        .catch(err => {
          loading.remove();
          appendMessage('ai', 'Connection error ‚Äî try again.');
          console.error(err);
        });
    }

    // ============ Quick tools ============
    function triggerQuickTask(type){
      const topic = document.getElementById('quick-topic').value.trim();
      if(!topic){ showModal('Please enter a topic.'); return; }
      document.getElementById('quick-result-area').style.display = '';
      document.getElementById('quick-loading').style.display = 'block';
      document.getElementById('quick-response').innerHTML = '';
      let prompt = '';
      if(type === 'explain') prompt = `Explain "${topic}" simply. Bold key terms.`;
      else if(type === 'quiz') prompt = `3 multiple choice questions on "${topic}". Answers at bottom.`;
      else prompt = `1-week study plan for "${topic}". Bullet points.`;

      callGemini([{ role:'user', parts:[{text: prompt}] }])
        .then(res => {
          document.getElementById('quick-loading').style.display = 'none';
          document.getElementById('quick-response').innerHTML = marked.parse(res);
        })
        .catch(err => {
          document.getElementById('quick-loading').style.display = 'none';
          document.getElementById('quick-response').textContent = 'Error fetching result.';
          console.error(err);
        });
    }
    function closeQuickResult(){ document.getElementById('quick-result-area').style.display = 'none'; }

    // ============ API call (example) ============
    // IMPORTANT: do not put a real API key in the client. Use a server-side proxy that injects the key.
    async function callGemini(payload){
      if(!API_KEY){
        // fallback mock response for local development
        return Promise.resolve("Demo response (no API key configured). Replace API_KEY with a runtime secret or call your backend proxy that holds the key.");
      }
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
      const res = await fetch(url, {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ contents: payload })
      });
      if(!res.ok) throw new Error('status:'+res.status);
      const data = await res.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response.';
    }

    // initialize chat from storage
    (function loadChat(){
      if(chatHistory && chatHistory.length){
        chatContainer.innerHTML = '';
        chatHistory.forEach(m => {
          const div = document.createElement('div');
          div.className = 'bubble ' + (m.role === 'user' ? 'user' : 'ai');
          div.innerHTML = (m.role === 'ai') ? marked.parse(m.text) : m.text;
          chatContainer.appendChild(div);
        });
        scrollChatToBottom();
      }
    })();
  </script>
</body>
</html>
